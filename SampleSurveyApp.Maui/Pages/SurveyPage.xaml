<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="SampleSurveyApp.Maui.Pages.SurveyPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:SampleSurveyApp.Core.ViewModels;assembly=SampleSurveyApp.Core"
             xmlns:models="clr-namespace:SampleSurveyApp.Core.Domain;assembly=SampleSurveyApp.Core"
             xmlns:controls="clr-namespace:SampleSurveyApp.Maui.Controls"
             x:Name="SurveyPageName"
             x:DataType="vm:SurveyPageVM">

    <ContentPage.Resources>
       
         <Style x:Key="InvalidEntryStyle"
               TargetType="Entry">
            <Setter Property="TextColor" Value="IndianRed"/>

        </Style>

        <Style x:Key="ValidEntryStyle"
               TargetType="Entry">
            <Setter Property="TextColor" Value="Green"/>
        </Style>
    </ContentPage.Resources>

    <Shell.TitleView>
        <Grid RowDefinitions="*" ColumnDefinitions="*,2*,*">
          <Button Text="{Binding LeftBtnLbl}"
                  BackgroundColor="Transparent"
                  TextColor="White"
                  FontSize="18"
                  Grid.Column="0"
                  HorizontalOptions="Start"
                  Command="{Binding BackButtonClickedCommand}"
                  IsVisible="{Binding IsWorkingLeftBtn}"
                  IsEnabled="{Binding IsWorkingLeftBtn}"/>
                <Label x:Name="titleLabel" FontSize="20" FontAttributes="Bold"
                       Text="{Binding ScreenNameLbl}"
                       HorizontalTextAlignment="Center"
                       BackgroundColor="Transparent" TextColor="White" Grid.Column="1" />
           <Button Text="{Binding RightBtnLbl}"
                   BackgroundColor="transparent"
                   TextColor="White"
                   Grid.Column="2" FontSize="18"
                   HorizontalOptions="End"
                   Command="{Binding NextButtonClickedCommand}"
                   IsVisible="{Binding IsWorkingRightBtn}"
                   IsEnabled="{Binding IsWorkingRightBtn}"/>
            </Grid>
    </Shell.TitleView>

    <StackLayout>
        <StackLayout IsVisible="{Binding IsVisibleSurveyHeader}" Padding="0,10,0,10">
            <Button Text="Start a survey"
                        WidthRequest="200"
                        HeightRequest="30"
                        FontSize="Micro"
                        Command="{Binding CreateSurveyCommand}"
                        BackgroundColor="green"/>
            
        </StackLayout>

          
   <!-- Survey-->
        <!-- Survey Header Info-->
        <StackLayout IsVisible="true">
            <StackLayout BackgroundColor="CornflowerBlue"
                                Padding="5">
                <Label Text="{Binding SPID}" HorizontalTextAlignment="Center"
                        VerticalTextAlignment="Center"/>
            </StackLayout>

            <FlexLayout BackgroundColor="PeachPuff">
                <Label Text="{Binding CurrentQuestionLbl}"
                       VerticalOptions="Center"
                       Margin="10,0,10,0"/>
            </FlexLayout>

            <StackLayout Grid.Row="2"
                                 Padding="5">
                <Label Text="{Binding InstructionLbl}" Margin="10,0,0,0"
                       TextColor="Blue"/>
            </StackLayout>
        
       </StackLayout>

        <!-- Container for Answers -->
        <StackLayout>
             <!--QuestionType is List, RuleType is Single-->
             <CollectionView x:Name="listSingleCv"
                         ItemsSource="{Binding AnswerOptionsForCurrentQuestionCollection}"
                                SelectionMode="Single"
                                SelectedItem="{Binding UserSelectedAnswer, Mode=TwoWay}"
                                SelectionChangedCommand="{Binding AnswerSelectedCommand}"
                                SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Self}}"
                                BackgroundColor="Transparent"
                                Margin="12,8,12,0"
                                IsVisible="{Binding IsVisibleRuleTypeSingle}">
                    <CollectionView.Triggers>
                        <Trigger TargetType="CollectionView"
                                    Property="IsVisible"
                                    Value="False">
                            <Setter Property="HeightRequest"
                                    Value="0"/>
                        </Trigger>
                        <Trigger TargetType="CollectionView"
                                    Property="IsVisible"
                                    Value="True">
                            <Setter Property="HeightRequest"
                                    Value="450"/>
                            </Trigger>
                    </CollectionView.Triggers>
                
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:SurveyAnswerModel">
                            <controls:AnswerOptionCardView  />
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

             <!--QuestionType is List, RuleType is Multiple-->
            <CollectionView x:Name="MultipleSelectionsCV"
                            ItemsSource="{Binding AnswerOptionsForCurrentQuestionCollection}"
                            SelectionMode="Multiple"
                            SelectionChangedCommand="{Binding MultipleSelectionCommand}"
                            SelectionChangedCommandParameter="{Binding SelectedItems, Source={x:Reference MultipleSelectionsCV}}"
                            IsVisible="{Binding IsVisibleRuleTypeMultiple}">
                <CollectionView.Triggers>
                    <Trigger TargetType="CollectionView"
                                Property="IsVisible"
                                Value="False">
                        <Setter Property="HeightRequest"
                                Value="0"/>
                    </Trigger>
                    <Trigger TargetType="CollectionView"
                                Property="IsVisible"
                                Value="True">
                        <Setter Property="HeightRequest"
                                Value="450"/>
                        </Trigger>
                </CollectionView.Triggers>
                <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:SurveyAnswerModel">
                            <controls:AnswerOptionCardView  />
                        </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

             <!--QuestionType is Text-->
                <Frame HeightRequest="200"
                       BorderColor="LightGray"
                       Padding="0"
                       IsVisible="{Binding IsVisibleQTypeText}">
                    <Frame.Triggers>
                        <Trigger TargetType="Frame"
                                    Property="IsVisible"
                                    Value="False">
                            <Setter Property="HeightRequest"
                                    Value="0"/>
                        </Trigger>
                        <Trigger TargetType="Frame"
                                    Property="IsVisible"
                                    Value="True">
                            <Setter Property="HeightRequest"
                                    Value="450"/>
                            </Trigger>
                    </Frame.Triggers>
                    <StackLayout>
                        <Editor x:Name="txtEditor"
                                Placeholder="Text goes here"
                                HeightRequest="250"
                                IsEnabled="{Binding IsVisibleQTypeText}"
                                Text="{Binding UserTextAnswer, Mode=TwoWay}">
                            <Editor.Behaviors>
                                <toolkit:EventToCommandBehavior
                                    EventName="TextChanged"
                                    Command="{Binding UserTextAnswerChangedCommand}"/>
                                <toolkit:CharactersValidationBehavior
                                    MinimumLength="3"
                                    MaximumLength="25"
                                    Flags="ValidateOnValueChanged"
                                    CharacterType="Digit"
                                    InvalidStyle="{StaticResource InvalidEntryStyle}"
                                    ValidStyle="{StaticResource ValidEntryStyle}"
                                    MaximumCharacterTypeCount="{Binding TextLen, Source={x:Reference MaximumCharacterCountEntry}}"
                                    MinimumCharacterTypeCount="{Binding TextLen, Source={x:Reference MinimumCharacterCountEntry}}"/>
                            </Editor.Behaviors>

                        </Editor>
                        </StackLayout>
                </Frame>

          <!--REVIEW ANSWERS-->
           <CollectionView x:Name="responseCV"
                            ItemsSource="{Binding UserAnswerGroups}"
                            IsGrouped="True"
                            IsVisible="{Binding IsVisibleAnswerReview}">
                 <!--<CollectionView.Triggers>
                    <Trigger TargetType="CollectionView"
                                Property="IsVisible"
                                Value="False">
                        <Setter Property="HeightRequest"
                                Value="0"/>
                    </Trigger>
                    <Trigger TargetType="CollectionView"
                                Property="IsVisible"
                                Value="True">
                        <Setter Property="HeightRequest"
                                Value="450"/>
                        </Trigger>
                </CollectionView.Triggers>-->
                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate>
                        <VerticalStackLayout>
                            <StackLayout BackgroundColor="PeachPuff"
                                         Padding="5,10,5,9"
                                         VerticalOptions="CenterAndExpand">
                                <Label Text="{Binding QText}"
                                       TextColor="Black"
                                       FontAttributes="Bold"/>
                            </StackLayout>
                            <BoxView BackgroundColor="LightBlue"
                                     HeightRequest="1"/>
                        </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>
            <CollectionView.ItemTemplate>
                    <DataTemplate>
                         <VerticalStackLayout>
                                    <Label Text="{Binding AText}" Padding="5,10,5,10"/>
                                    <BoxView BackgroundColor="LightBlue"
                                             HeightRequest="1"/>
                            </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>
       
    </StackLayout>
      
</ContentPage>